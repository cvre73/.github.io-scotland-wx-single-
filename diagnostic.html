
<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Scotland WX — Diagnostic</title>
<style>
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:#0b0d12;color:#e7ecff}
  .wrap{max-width:900px;margin:0 auto;padding:14px}
  h1{font-size:18px;margin:0 0 10px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .card{background:#121621;border:1px solid #1f2636;border-radius:12px;padding:12px}
  .ok{color:#42d392}.warn{color:#ffbd2e}.bad{color:#ff7b7b}
  code{background:#0f1320;border:1px solid #1f2636;border-radius:6px;padding:2px 4px}
  pre{white-space:pre-wrap;background:#0f1320;border:1px solid #1f2636;border-radius:8px;padding:8px;max-height:220px;overflow:auto}
  button{background:#121621;color:#e7ecff;border:1px solid #1f2636;border-radius:10px;padding:8px 12px;cursor:pointer}
</style>
</head>
<body>
<div class="wrap">
  <h1>Scotland WX — Diagnostic</h1>
  <div class="grid">
    <div class="card">
      <h3>1) JavaScript</h3>
      <div id="jsStatus">Checking…</div>
    </div>
    <div class="card">
      <h3>2) Geolocation</h3>
      <div id="geoStatus">Not started</div>
      <button id="btnGeo">Try My Location</button>
    </div>
    <div class="card">
      <h3>3) Yr.no API</h3>
      <div id="metStatus">Not started</div>
      <button id="btnMet">Test Fetch</button>
      <pre id="metOut"></pre>
    </div>
    <div class="card">
      <h3>4) Windy Iframe</h3>
      <div id="windStatus">Not started</div>
      <iframe id="wind" style="width:100%;height:180px;border:0;border-radius:8px"></iframe>
    </div>
  </div>
  <div class="card" style="margin-top:10px">
    <h3>Console errors (captured)</h3>
    <pre id="errors">(none yet)</pre>
  </div>
</div>
<script>
const $ = id => document.getElementById(id);
const DEFAULT = { lat: 56.8742586, lon: -2.2599375 };

(function jsCheck(){ $('jsStatus').innerHTML = '<b class="ok">JS running ✔︎</b>'; })();

// Capture console errors visibly
(function(){
  const oldErr = console.error;
  console.error = function(...args){
    try{ const s = args.map(a => (a&&a.stack)?a.stack:JSON.stringify(a)).join(' ');
      const pre = $('errors'); pre.textContent = pre.textContent==='(none yet)'? s : pre.textContent + '\n' + s;
    }catch(e){}
    oldErr.apply(console, args);
  };
  window.addEventListener('error', e => {
    const pre = $('errors');
    pre.textContent = (pre.textContent==='(none yet)'?'':'\n') + (e.message||'Error') + (e.filename?(' @ '+e.filename+':'+e.lineno):'');
  });
})();

// Geolocation
$('btnGeo').addEventListener('click', ()=>{
  if(!navigator.geolocation){ $('geoStatus').innerHTML = '<span class="bad">No geolocation API</span>'; return; }
  $('geoStatus').textContent = 'Requesting permission…';
  navigator.geolocation.getCurrentPosition(pos=>{
    const {latitude, longitude} = pos.coords;
    $('geoStatus').innerHTML = '<b class="ok">OK</b> ' + latitude.toFixed(5)+', '+longitude.toFixed(5);
    setWind(latitude, longitude);
  }, err=>{
    $('geoStatus').innerHTML = '<span class="bad">Denied/Failed:</span> ' + err.message;
  }, {enableHighAccuracy:true, timeout:8000, maximumAge:60000});
});

// Yr.no test
async function testMet(lat=DEFAULT.lat, lon=DEFAULT.lon){
  $('metStatus').textContent = 'Fetching…';
  try{
    const r = await fetch(`https://api.met.no/weatherapi/locationforecast/2.0/compact?lat=${lat}&lon=${lon}`, {headers:{'Accept':'application/json'}});
    const txt = await r.text();
    $('metOut').textContent = 'HTTP ' + r.status + ' ' + r.statusText + '\n' + txt.slice(0,400) + (txt.length>400?'…':'');
    if(!r.ok) $('metStatus').innerHTML = '<span class="bad">Failed</span>'; else $('metStatus').innerHTML = '<b class="ok">OK</b>';
  }catch(e){
    $('metStatus').innerHTML = '<span class="bad">Fetch threw</span>';
    $('metOut').textContent = String(e);
    console.error(e);
  }
}
$('btnMet').addEventListener('click', ()=> testMet());

// Windy
function setWind(lat=DEFAULT.lat, lon=DEFAULT.lon){
  $('windStatus').textContent = 'Loading…';
  const src = `https://embed.windy.com/embed2.html?lat=${lat.toFixed(3)}&lon=${lon.toFixed(3)}&zoom=11&level=surface&overlay=wind&menu=&message=&marker=&calendar=now`;
  const f = $('wind'); f.onload = ()=> $('windStatus').innerHTML = '<b class="ok">Loaded</b>'; f.onerror = ()=> $('windStatus').innerHTML = '<span class="bad">Blocked</span>';
  f.src = src;
}
setWind();
testMet();
</script>
</body>
</html>
